<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>记一个 k8s 中 service 的 clusterIP 配置错误的排查过程 · Filosfino</title><meta name="description" content="记一个 k8s 中 service 的 clusterIP 配置错误的排查过程| |filosfino 分享阅读经验、学习、编程、观点、见闻、效率工具的地方"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css"><link rel="alternate" type="application/atom+xml" href="https://blog.filosfino.com/atom.xml" title="Filosfino"><meta name="generator" content="Hexo 5.4.2"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/zheduanyin/activities" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="https://twitter.com/filosfino" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/filosfino" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul><div class="subtitle">喜欢观察世界，也出走过青铜时代、梦马臆想</div></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">记一个 k8s 中 service 的 clusterIP 配置错误的排查过程<span class="post-info">2020年4月30日</span></h1><a class="link"></a><a class="link"></a><a class="link"></a><div class="post-content"><span id="more"></span>

<p>先讲讲项目的性质和部署方式，项目是前后端分离的，都用的 gitlab 的 CI/CD 去打镜像，build stage 过了后发到 k8s（前后端并发 apply 自己的 k8s yml），即<br><code>git tag -&gt; lint + test -&gt; build -&gt; build docker image -&gt; k8s apply yml -&gt; notify</code></p>
<p>k8s 集群的部署环境简化一下是这样的 <br><code> 阿里云 SLB -&gt; k8s ingress -&gt; fe service -&gt; be service -&gt; DB</code><br><code>阿里云 SLB -&gt; k8s ingress -&gt; be service -&gt; DB</code><br>也是比较典型的配置方式，其中前端是用 <code>openresty</code> 在 <code>docker image</code> 中带起来的</p>
<p>有几次发现部署不稳定，现象是前端 <code>502</code>，报的 <code>cannot find route to xx.xx.xx.xx</code>，检查了一下配置，确认没问题，在 <code>fe pod</code> 中重启 <code>openresty</code>，发现 <code>fe</code> 可以正常工作了，但过了一段时间后又挂了。看了一下这段时间的操作，有一次发版行为，不能确定是发版导致的还是 <code>be</code> 挂掉重启（被 k8s 重新配了一个 IP 地址）导致的 IP 失效。于是找了一套环境发版来尝试复现，发版前记录 <code>pod/service</code> 的 IP，发版，发现前端 <code>502</code> 了，报错信息中的 <code>upstream IP</code> 是发版前的 <code>be pod</code> 地址。等发版完成后去看了一下 <code>be pod</code> 的地址，果真已经变了。</p>
<p>yo<del>xi</del> 问题应该就在这里了，解析是没问题的，只是 <code>openresty</code> 部署的时候比后端先启动，缓存了老的 <code>be IP</code>。那么解法可以是</p>
<ol>
<li>禁用 <code>dns</code>，影响性能</li>
<li><code>dns</code> 配置超时，一定程度的可用性降低，一定程度影响性能</li>
<li>监听 <code>k8s be service</code> 启动、重启事件，收到后在 <code>openresty</code> 刷新 <code>dns</code>，需要开发，开发团队自己确保基础设施的可靠性</li>
<li>保证 <code>k8s be deployment</code> 完成后再做 <code>k8s fe deployment</code>，用确保时序的方式避免部署问题，但不能解决后续可能出现的重启问题</li>
</ol>
<p>想了一想好像这个需求应该是很常见的，社区一定有解法，搜了一溜发现并没有，奇怪的是提这个问题的人都少之又少，那他们是怎么解决的呢？然后就去翻了 <code>k8s</code> 文档，应该属于服务发现范畴，看到了<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies">VIP</a>，这不是之前做数据库热切用到的么，看起来是能解决问题的，但看着有点重，看到这里发现 <code>service</code> 有个 <code>ClusterIP</code> 的概念，在 <code>service</code> 的生命周期里是不会变的，就是用来做 <code>service</code> 解耦的，外部不需要知道 <code>service</code> 里面有什么。那么问题来了，这个行为是默认的，为什么 <code>fe openresty dns</code> 会解析出 <code>be pod</code> 的 <code>IP</code> 呢？应该是一个 <code>service ClusterIP</code> 才对。检查了一下运维同学的 <code>yml</code> 才发现 <code>clusterIP</code> 都设置了 <code>none</code>。。。忽然想起很多性能调优不稳定的往事。。。真的是。。</p>
<p><img src="https://i.imgur.com/HHkX3Sc.gif" alt=""></p>
<p>架构级的东西比代码更需要 review 啊</p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/05/02/%E5%AD%A9%E5%AD%90%E6%80%8E%E4%B9%88%E7%9C%8B%E5%BE%85%E8%99%9A%E5%BC%A0%E5%A3%B0%E5%8A%BF/" class="prev">← 孩子怎么看待虚张声势</a><a href="/2020/03/10/%E7%BC%96%E7%A8%8B%E4%B8%AD%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%B7%A5%E7%A8%8B%E8%A6%81%E7%82%B9/" class="next">编程中要注意的工程要点 →</a></div><hr><div class="tagcloud"><p>随意看看</p><a href="/tags/AI/" style="font-size: 12px; color: #808080">AI</a> <a href="/tags/Architecture/" style="font-size: 12px; color: #808080">Architecture</a> <a href="/tags/Career/" style="font-size: 12px; color: #808080">Career</a> <a href="/tags/Comics/" style="font-size: 14.88px; color: #707070">Comics</a> <a href="/tags/Craft/" style="font-size: 23.5px; color: #404040">Craft</a> <a href="/tags/Diary/" style="font-size: 35px; color: #000">Diary</a> <a href="/tags/Django/" style="font-size: 14.88px; color: #707070">Django</a> <a href="/tags/Dota/" style="font-size: 14.88px; color: #707070">Dota</a> <a href="/tags/Game/" style="font-size: 29.25px; color: #202020">Game</a> <a href="/tags/Music/" style="font-size: 12px; color: #808080">Music</a> <a href="/tags/NLP/" style="font-size: 12px; color: #808080">NLP</a> <a href="/tags/Piano/" style="font-size: 12px; color: #808080">Piano</a> <a href="/tags/Programming/" style="font-size: 12px; color: #808080">Programming</a> <a href="/tags/Python/" style="font-size: 12px; color: #808080">Python</a> <a href="/tags/Quotation/" style="font-size: 32.13px; color: #101010">Quotation</a> <a href="/tags/Reading/" style="font-size: 29.25px; color: #202020">Reading</a> <a href="/tags/Rust/" style="font-size: 12px; color: #808080">Rust</a> <a href="/tags/Tech/" style="font-size: 20.63px; color: #505050">Tech</a> <a href="/tags/Thought/" style="font-size: 26.38px; color: #303030">Thought</a> <a href="/tags/Ukulele/" style="font-size: 17.75px; color: #606060">Ukulele</a><a target="_blank" rel="noopener" href="//program-think.blogspot.com/" class="link">编程随想</a><a target="_blank" rel="noopener" href="//blog.farmostwood.net/" class="link">木遥的窗子</a><a target="_blank" rel="noopener" href="//plantain-00.github.io/" class="link">plantain-00</a><a target="_blank" rel="noopener" href="//morningchen.com/" class="link">西西君</a></div><hr><div id="disqus_thread"></div><script>var disqus_shortname = 'filosfino';
var disqus_identifier = '2020/04/30/记一个k8s中service的clusterIP配置错误的排查过程/';
var disqus_title = '记一个 k8s 中 service 的 clusterIP 配置错误的排查过程';
var disqus_url = 'https://blog.filosfino.com/2020/04/30/记一个k8s中service的clusterIP配置错误的排查过程/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//filosfino.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2022 <a href="https://blog.filosfino.com">filosfino</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-94010149-1",'auto');ga('send','pageview');</script></body></html>